---
# If true, the FSM transitions are managed by an external tool
Managed: false
# If true and the FSM is self-managed, transitions should be triggered
StepByStep: true
# Change idle behaviour, if true the state is kept until transition,
# otherwise the FSM holds the last state until transition
IdleKeepState: false
# Where to look for state libraries
StatesLibraries:
- "@MC_STATES_DEFAULT_RUNTIME_INSTALL_PREFIX@"
- "@MC_STATES_RUNTIME_INSTALL_PREFIX@"
# Where to look for state files
StatesFiles:
- "@MC_STATES_DEFAULT_RUNTIME_INSTALL_PREFIX@/data"
- "@MC_STATES_RUNTIME_INSTALL_PREFIX@/data"
# If true, state factory will be more verbose
VerboseStateFactory: false
# Additional robots to load
robots:
  ground:
    module: env/ground
  robot_2:
    module: JVRC1
  human_1:
    module: human
  human_2:
    module: human
# General constraints, always on
constraints:
- type: contact
  damper: [0.1, 0.01, 0.5]
- type: compoundJoint
# Collision constraint
collisions:
- type: collision
  useMinimal: true
# Initial set of contacts
contacts:
- r2: ground
  r1Surface: LeftFoot
  r2Surface: AllGround
- r2: ground
  r1Surface: RightFoot
  r2Surface: AllGround
- r2: ground
  r1: robot_2
  r1Surface: LeftFoot
  r2Surface: AllGround
- r2: ground
  r1: robot_2
  r1Surface: RightFoot
  r2Surface: AllGround

human:
  limb_map:
    left_hand: "LHandLink"
    right_hand: "RHandLink"
    left_arm: "LArmLink"
    right_arm: "RArmLink"
    left_forearm: "LForearmLink"
    right_forearm: "RForearmLink" 
    pelvis: "HipsLink" 

states:
  BiTeleopTask_1:
    base: BiRobotTeleoperation_Task
    name: biRobotTask_1
    stiffness: 100
    softMaxGain: 10
    deltaDistGain: 0.1
    weight: 500
    arrow:
      shaft_diam: 0.005
    linearWeight:
      weightRange: [20,300]
      distanceRange: [0.3,0.1]
    robot_1:
      name: rhps1
      links: [LeftHand]
      unactive_joints: ["Root","CHEST_P","CHEST_Y"]
      limb_map:
        left_hand: 
          name: "L_WRIST_Y_LINK"
          axis: [0,0,-1]
        right_hand: 
          name: "R_WRIST_Y_LINK"
          axis: [0,0,1]
        left_arm: 
          name: "L_SHOULDER_Y_LINK"
          axis: [0,0,-1]
        right_arm: 
          name: "L_SHOULDER_Y_LINK"
          axis: [0,0,1]
        left_forearm:
          name: "L_ELBOW_Y_LINK"
          axis: [0,0,-1]
        right_forearm: 
          name: "R_ELBOW_Y_LINK"  
          axis: [0,0,1]
        pelvis:
          name: "BODY" 
    robot_2: 
      name: "robot_2"
      links: ["RightArm","RightForearm","RightHand"]
      unactive_joints: ["Root","WAIST_P","WAIST_R","WAIST_Y"]
      limb_map:
        left_hand:
          name: "L_WRIST_Y_S"
          axis: [0,0,1]
        right_hand: 
          name: "R_WRIST_Y_S"
          axis: [0,0,-1]
        left_arm:
          name: "L_SHOULDER_Y_S"
          axis: [0,0,1]
        right_arm:
          name: "R_SHOULDER_Y_S"
          axis: [0,0,-1]
        left_forearm:
          name: "L_ELBOW_P_S"
          axis: [0,0,1]
        right_forearm:
          name: "R_ELBOW_P_S" 
          axis: [0,0,-1]
        pelvis: 
          name: "WAIST_Y_S" 
    human:
      convex:
        arm:
          radius: 0.05
          length: [0,0.2]
          axis:
            left: [0,1,0]
            right: [0,-1,0]
        forearm:
          radius: 0.03
          length: [0.,0.2]    
          axis:
            left: [0,1,0]
            right: [0,-1,0]
        hand:
          radius: 0.06
          length: [0.0,0.1]    
          axis:
            left: [0,1,0]
            right: [0,-1,0]
  
  BiTeleopTask_2:
    base: BiTeleopTask_1
    name: biRobotTask_2
    arrow:
      color: [0,0,255,1]
    robot_1:
      links: [LeftArm,LeftForearm,LeftHand]
    robot_2:
      isMainRobot: 0
      links: ["RightHand"]

  RobotDamping_1:
   base: HandDamping
   name: Robot_1_HandDamping
   robot_name: rhps1
   human_targetLimb: LeftHand
   human_indx: 0
   task:
    type: transform
    unactiveJoints: ["Root","CHEST_P","CHEST_Y"]
    frame: LeftHandWrench 
    dimWeight: [0,0,0,1,1,1]   
    weight: 30
    damping: 100

  RobotDamping_2:
   base: RobotDamping_1
   name: Robot_2_HandDamping
   robot_name: robot_2
   human_indx: 1
   task:     
    unactiveJoints: ["Root","WAIST_P","WAIST_R","WAIST_Y"]
    frame: R_WRIST_Y_S        

  HumanHandTrajTasks:
    base: MetaTasks
    tasks:
      Human_1_Right:
          type: bspline_trajectory
          name: Human_1_RightHand
          robot: human_1
          frame: LHandLink
          stiffness: 100
          weight: 10
          dimWeight: [0,0,0,1,1,1]
          unactiveJoints: ["Root"]
          targetFrame:
            robot: robot_2
            frame: R_SHOULDER_Y_S
            translation: [0.,0.,0]
          completion:
            timeElapsed: true
      Human_2_Left:
          type: bspline_trajectory
          name: Human_2_LeftHand
          robot: human_2
          frame: RHandLink
          unactiveJoints: ["Root"]
          targetFrame:
            robot: rhps1
            frame: L_SHOULDER_Y_LINK
            translation: [0.,0.1,0]
            controlPoints: [[0,0.8,0]]
          stiffness: 100
          dimWeight: [0,0,0,1,1,1]
          weight: 10
          duration : 5
          completion:
            timeElapsed: true

  HumanHandTasks:
    base: MetaTasks
    tasks:
      Human_1_Right:
          type: transform
          name: Human_1_RightHand
          robot: human_1
          frame: LHandLink
          stiffness: 100
          weight: 10
          unactiveJoints: ["Root"]
          completion:
            eval: 0
      Human_2_Left:
          type: transform
          name: Human_2_LeftHand
          robot: human_2
          frame: RHandLink
          unactiveJoints: ["Root"]
          stiffness: 100
          weight: 10
          duration : 5
          completion:
            eval: 0

  RobotArm_1:
    base: RelativePose
    robot_name: rhps1
    human_indx: 0
    human_targetLimb: LeftArm
    robot_refFrame: BODY
    completion_eval: 5e-3
    human_robot_RefTransfo: 
      translation: [0.,0.,0.]
      rotation: [0.,0.,0.]
    human_robot_TargetTransfo: 
      translation: [0.,0.,0.]
      rotation: [1.57,0.,0.]
    task:
      type: transform
      unactiveJoints: ["Root","CHEST_P","CHEST_Y"]
      frame: L_SHOULDER_Y_LINK
      dimWeight: [1,1,1,0,0,0]   
      weight: 300
      stiffness: 20

  RobotArm_2:
    base: RobotArm_1
    robot_name: robot_2
    human_indx: 1
    human_targetLimb: RightArm
    robot_refFrame: base_link
    human_robot_RefTransfo: 
      translation: [0.,0.,0.]
      rotation: [0.,0.,0.]
    human_robot_TargetTransfo: 
      translation: [0.,0.,0.]
      rotation: [-1.57,0.,0.]
    task:
      unactiveJoints: ["Root","WAIST_P","WAIST_R","WAIST_Y"]
      frame: R_SHOULDER_Y_S
      dimWeight: [1,1,1,0,0,0]   
    
  RobotForearm_1:
    base: RobotArm_1
    human_targetLimb: LeftForearm
    task:
      frame: L_ELBOW_Y_LINK

  RobotForearm_2:
    base: RobotArm_2
    human_targetLimb: RightForearm
    task:
      frame: R_ELBOW_P_S

  RobotHand_1:
    base: RobotArm_1
    human_targetLimb: LeftHand
    task:
      frame: L_WRIST_Y_LINK

  RobotHand_2:
    base: RobotArm_2
    human_targetLimb: RightHand
    task:
      frame: R_WRIST_Y_S

  BiTeleop_RobotArm_1:
    base: RobotArm_1
    completion_eval: 0
    weight: 100
    stiffness: 20
  
  BiTeleop_RobotArm_2:
    base: RobotArm_2
    completion_eval: 0
    weight: 100
    stiffness: 20

  BiTeleop_RobotForearm_1:
    base: BiTeleop_RobotArm_1
    human_targetLimb: LeftForearm
    task:
      frame: L_ELBOW_Y_LINK
  
  BiTeleop_RobotForearm_2:
    base: BiTeleop_RobotArm_2
    human_targetLimb: RightForearm
    task:
      frame: R_ELBOW_P_S

  BiTeleop_RobotHand_1:
    base: BiTeleop_RobotArm_1
    human_targetLimb: LeftHand
    task:
      frame: L_WRIST_Y_LINK
  
  BiTeleop_RobotHand_2:
    base: BiTeleop_RobotArm_2
    human_targetLimb: RightHand
    task:
      frame: R_WRIST_Y_S

  BiRobot::Teleop:
    base: Parallel
    states:
    - BiTeleopTask_1
    - BiTeleopTask_2
  
  Robot::Teleop:
    base: Parallel
    states:
    - BiTeleop_RobotArm_1
    - BiTeleop_RobotArm_2
    - BiTeleop_RobotForearm_1
    - BiTeleop_RobotForearm_2
    - BiTeleop_RobotHand_1
    - BiTeleop_RobotHand_2
  
  Teleop:
    base: Parallel
    states:
    - Robot::Teleop
    - BiRobot::Teleop

  Human::Trajectory:
    base: Parallel
    states: 
    - HumanHandTrajTasks

  Human::Free:
    base: Parallel
    states: 
    - HumanHandTasks
  
  Human:
    base: Meta
    transitions:
      - [Human::Trajectory,OK,Human::Free,Auto]
  
  PostureImitation:
    base: Parallel
    states:
    - RobotArm_1
    - RobotArm_2
    - RobotForearm_1
    - RobotForearm_2
    - RobotHand_1
    - RobotHand_2
  
  MainState:
    base: Parallel
    states:
    - Teleop
    - Human

transitions:
- [BiRobotTeleoperation_Initial, OK, PostureImitation, Strict]
- [PostureImitation, OK, MainState, Auto]

# Initial state
init: BiRobotTeleoperation_Initial
