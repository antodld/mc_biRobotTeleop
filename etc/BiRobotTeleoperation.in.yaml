---
# If true, the FSM transitions are managed by an external tool
Managed: false
# If true and the FSM is self-managed, transitions should be triggered
StepByStep: true
# Change idle behaviour, if true the state is kept until transition,
# otherwise the FSM holds the last state until transition
IdleKeepState: false
# Where to look for state libraries
StatesLibraries:
- "@MC_STATES_DEFAULT_RUNTIME_INSTALL_PREFIX@"
- "@MC_STATES_RUNTIME_INSTALL_PREFIX@"
# Where to look for state files
StatesFiles:
- "@MC_STATES_DEFAULT_RUNTIME_INSTALL_PREFIX@/data"
- "@MC_STATES_RUNTIME_INSTALL_PREFIX@/data"
# If true, state factory will be more verbose
VerboseStateFactory: false
# Additional robots to load
robots:
  ground:
    module: env/ground
  robot_2:
    module: JVRC1
  human_1:
    module: human
  human_2:
    module: human
# General constraints, always on
constraints:
- type: contact
  damper: [0.1, 0.01, 0.5]
- type: compoundJoint
# Collision constraint
collisions:
- type: collision
  useMinimal: true
# Initial set of contacts
contacts:
- r2: ground
  r1Surface: LeftFoot
  r2Surface: AllGround
- r2: ground
  r1Surface: RightFoot
  r2Surface: AllGround
- r2: ground
  r1: robot_2
  r1Surface: LeftFoot
  r2Surface: AllGround
- r2: ground
  r1: robot_2
  r1Surface: RightFoot
  r2Surface: AllGround

states:
  BiTeleopTask_1:
    base: BiRobotTeleoperation_Task
    name: biRobotTask_1
    stiffness: 50
    weight: 500
    robot_1:
      name: rhps1
      link: LeftHand
      unactive_joints: ["Root","CHEST_P","CHEST_Y"]
      limb_map:
        left_hand: "L_WRIST_Y_LINK"
        right_hand: "R_WRIST_Y_LINK"
        left_arm: "L_SHOULDER_Y_LINK"
        right_arm: "L_SHOULDER_Y_LINK"
        left_forearm: "L_ELBOW_Y_LINK"
        right_forearm: "R_ELBOW_Y_LINK"  
        pelvis: "BODY" 
    robot_2: 
      name: "robot_2"
      link: RightArm
      unactive_joints: ["Root","WAIST_P","WAIST_R","WAIST_Y"]
      limb_map:
        left_hand: "L_WRIST_Y_S"
        right_hand: "R_WRIST_Y_S"
        left_arm: "L_SHOULDER_Y_S"
        right_arm: "R_SHOULDER_Y_S"
        left_forearm: "R_ELBOW_P_S"
        right_forearm: "R_ELBOW_P_S" 
        pelvis: "WAIST_Y_S" 
    human:
      convex:
        arm:
          radius: 0.05
          axis: [0,1,0]
          length: [0.2,0]
        forearm:
          radius: 0.03
          length: [0.2,0.]    
          axis: [0,1,0]
        hand:
          radius: 0.06
          length: [0.0,0.1]    
          axis: [0,1,0]
  
  BiTeleopTask_2:
    base: BiTeleopTask_1
    name: biRobotTask_2
    robot_1:
      link: LeftArm
    robot_2:
      link: RightHand

  RobotDamping_1:
   base: HandDamping
   name: Robot_1_HandDamping
   robot_name: rhps1
   human_targetLimb: LeftHand
   human_indx: 0
   task:
    type: transform
    unactiveJoints: ["Root","CHEST_P","CHEST_Y"]
    frame: LeftHandWrench 
    dimWeight: [0,0,0,1,1,1]   
    weight: 30
    damping: 100

  RobotDamping_2:
   base: RobotDamping_1
   name: Robot_2_HandDamping
   robot_name: robot_2
   human_indx: 1
   task:     
    unactiveJoints: ["Root","WAIST_P","WAIST_R","WAIST_Y"]
    frame: R_WRIST_Y_S        

  HumanHandTasks:
    base: MetaTasks
    tasks:
      Human_1_Right:
          type: bspline_trajectory
          name: Human_1_RightHand
          robot: human_1
          frame: LHandLink
          stiffness: 100
          weight: 10
          dimWeight: [0,0,0,1,1,1]
          unactiveJoints: ["Root"]
          targetFrame:
            robot: robot_2
            frame: R_SHOULDER_Y_S
          completion:
            eval: 0
      Human_2_Left:
          type: bspline_trajectory
          name: Human_2_LeftHand
          robot: human_2
          frame: RHandLink
          unactiveJoints: ["Root"]
          targetFrame:
            robot: rhps1
            frame: L_SHOULDER_Y_LINK
            controlPoints: [[0,0.8,0]]
          stiffness: 100
          dimWeight: [0,0,0,1,1,1]
          weight: 10
          completion:
            eval: 0

  RobotArm_1:
    base: RelativePose
    robot_name: rhps1
    human_indx: 0
    human_targetLimb: LeftArm
    robot_refFrame: BODY
    completion_eval: 5e-3
    human_robot_RefTransfo: 
      translation: [0.,0.,0.]
      rotation: [0.,0.,0.]
    human_robot_TargetTransfo: 
      translation: [0.,0.,0.]
      rotation: [1.57,0.,0.]
    task:
      type: transform
      unactiveJoints: ["Root","CHEST_P","CHEST_Y"]
      frame: L_SHOULDER_Y_LINK
      dimWeight: [1,1,1,0,0,0]   
      weight: 300
      stiffness: 20

  RobotArm_2:
    base: RobotArm_1
    robot_name: robot_2
    human_indx: 1
    human_targetLimb: RightArm
    robot_refFrame: base_link
    human_robot_RefTransfo: 
      translation: [0.,0.,0.]
      rotation: [0.,0.,0.]
    human_robot_TargetTransfo: 
      translation: [0.,0.,0.]
      rotation: [-1.57,0.,0.]
    task:
      unactiveJoints: ["Root","WAIST_P","WAIST_R","WAIST_Y"]
      frame: R_SHOULDER_Y_S
      dimWeight: [1,1,1,0,0,0]   
  
  BiTeleop_RobotArm_1:
    base: RobotArm_1
    completion_eval: 0
    weight: 20
    stiffness: 20
  BiTeleop_RobotArm_2:
    base: RobotArm_2
    completion_eval: 0
    weight: 20
    stiffness: 20

  BiTeleop_RobotForearm_1:
    base: BiTeleop_RobotArm_1
    human_targetLimb: LeftForearm
    task:
      frame: L_ELBOW_Y_LINK


  BiTeleop_RobotForearm_2:
    base: BiTeleop_RobotArm_2
    human_targetLimb: RightForearm
    task:
      frame: R_ELBOW_P_S

  BiTeleop_RobotHand_1:
    base: BiTeleop_RobotArm_1
    human_targetLimb: LeftHand
    task:
      frame: L_WRIST_Y_LINK

  BiTeleop_RobotHand_2:
    base: BiTeleop_RobotArm_2
    human_targetLimb: RightHand
    task:
      frame: R_WRIST_Y_S


  BiTeleop:
    base: Parallel
    states: 
    - BiTeleopTask_1
    - BiTeleopTask_2
    # - RobotDamping_1
    # - RobotDamping_2
    - BiTeleop_RobotArm_1
    - BiTeleop_RobotArm_2
    - BiTeleop_RobotForearm_1
    - BiTeleop_RobotForearm_2
    - BiTeleop_RobotHand_1
    - BiTeleop_RobotHand_2
    - HumanHandTasks
  
  PostureImitation:
    base: Parallel
    states:
    - RobotArm_1
    - RobotArm_2


transitions:
- [BiRobotTeleoperation_Initial, OK, PostureImitation, Strict]
- [PostureImitation, OK, BiTeleop, Auto]

# Initial state
init: BiRobotTeleoperation_Initial
